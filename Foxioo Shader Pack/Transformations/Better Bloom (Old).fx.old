sampler2D S2D_Image : register(s0);
sampler2D S2D_Background : register(s1);

    float   _Intensity, 
            _Threshold, 
            _Distance, 
            _Mixing,
            _Alpha,
            _Distance_Average,

            fPixelWidth,fPixelHeight;

    bool    _Distance_Color;

/* too many float's 2!1!!! @w@ */

#define _BlurSize 30

static const float2 _Blur[_BlurSize] = 
{
    1, -0,
    0.489074, -0.103956,
    0.913545, -0.406737,
    0.404509, -0.293893,
    0.669131, -0.743145,
    0.25, -0.433013,
    0.309017, -0.951057,
    0.0522642, -0.497261,
    -0.104529, -0.994522,
    -0.154509, -0.475528,
    -0.5, -0.866025,
    -0.334565, -0.371572,
    -0.809017, -0.587785,
    -0.456773, -0.203368,
    -0.978148, -0.207912,
    -0.5, -0,
    -0.978148, 0.207912,
    -0.456773, 0.203368,
    -0.809017, 0.587786,
    -0.334565, 0.371572,
    -0.5, 0.866025,
    -0.154509, 0.475528,
    -0.104528, 0.994522,
    0.0522642, 0.497261,
    0.309017, 0.951056,
    0.25, 0.433013,
    0.669131, 0.743145,
    0.404508, 0.293893,
    0.913546, 0.406736,
    0.489074, 0.103956,
};

/************************************************************/
/* Bloom */
/************************************************************/

float4 Fun_Bloom_Combine(float4 _Bloom, float4 _Render) : COLOR0
{
    return _Render * (_Intensity / 10.0) + _Bloom;
}

/************************************************************/
/* Main */
/************************************************************/

float4 Main(in float2 In : TEXCOORD0) : COLOR0
{
    float4 _Result_Blur = tex2D(S2D_Background, In);
    
    float _Average;

        if(_Distance_Color == 1)
        {
            _Average = ((_Result_Blur.r + _Result_Blur.g + _Result_Blur.b) / 3.0) * _Distance_Average;
        }
        else if (_Distance_Color == 0)
        {
            _Average = 1;
        }

    /* BLUR!!!!! */
    for (int j = 0; j < 5; j++)
    {
        for (int i = 0; i < _BlurSize; i++)
        {
            _Result_Blur += tex2D(S2D_Background, max(0.0, min(1.0, In + ((_Distance / j * _Average) * float2(fPixelWidth, fPixelHeight) * _Blur[i]) / 2.0)));
        }
    }
    _Result_Blur /= 151;

    _Result_Blur.a *= _Alpha;
    
    /* and also bloom */
    float4 _Result_Bloom = Fun_Bloom_Combine(_Result_Blur, tex2D(S2D_Background, In));

        float _Luminance = dot(_Result_Bloom.rgb, float3(0.299, 0.587, 0.114));
        float _Threshold_Color = (_Luminance > _Threshold) ? _Result_Bloom : float4(0, 0, 0, 0);

    float4 _Result = (_Result_Bloom + _Threshold_Color);

        _Result.a *= _Average * tex2D(S2D_Image, In).a * _Mixing;

    return _Result;
}

/************************************************************/
/* Tech Main */
/************************************************************/

technique tech_main { pass P0 { PixelShader = compile ps_2_a Main(); } }

